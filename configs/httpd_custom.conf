<IfDefine ACME>
  LoadModule watchdog_module modules/mod_watchdog.so
  LoadModule md_module modules/mod_md.so
  LoadModule http2_module modules/mod_http2.so

  <IfModule ssl_module>
    SSLEngine on
    MDStoreDir /mnt/mdcerts
    <MDomain ${PHAIDRA_HOSTNAME}>
      MDCertificateAuthority ${CA_ENDPOINT}
      <IfDefine ACME_EAB>
        MDExternalAccountBinding ${HTTPD_ACME_KEYID} ${HTTPD_ACME_HMAC64}
      </IfDefine>
      MDCAChallenges tls-alpn-01
      Protocols h2 http/1.1 acme-tls/1
      ServerAdmin ${PHAIDRA_ADMIN_EMAIL}
      MDCertificateAgreement ${MD_CERTIFICATE_AGREEMENT}
    </MDomain>
  </IfModule>
</IfDefine>

<IfDefine !ACME>
  <IfModule ssl_module>
    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/server.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/server.key"
  </IfModule>
</IfDefine>

<IfDefine PFSA>
  ProxyPass /pfsa !
  Alias "/pfsa" "/mnt/pfsa"
  <Directory "/mnt/pfsa">
    SetOutputFilter RATE_LIMIT
    SetEnv rate-limit 512
    SetEnv rate-initial-burst 1024
    Options Indexes
    AllowOverride None
    Require all granted
  </Directory>
</IfDefine>

<IfDefine PFSA_REDIRECT>
  ProxyPass /pfsa !
  RedirectMatch 302 ^/pfsa(/.*)?$ https://${HTTPD_PFSA_REDIRECT_FQDN}/pfsa$1
</IfDefine>

<IfModule headers_module>
  # Excludes: /dbgate, /grafana, /lam, /fcrepo, /solr, /sitemap, /static
  <LocationMatch "^/(?!dbgate|grafana|lam|fcrepo|solr|sitemap|static).*">
    Header set Content-Security-Policy "default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; connect-src 'self' https://api.dante.gbv.de https://api.crossref.org https://api.datacite.org https://ws.gbv.de https://doi.org https://citation.doi.org https://api.ror.org https://v2.sherpa.ac.uk https://vocab.phaidra.org https://yarm.phaidra.org; img-src 'self' data: https://*.tile.osm.org https://*.tile.openstreetmap.org; style-src 'self' 'unsafe-inline'; base-uri 'self';form-action 'self'; font-src 'self' data:; media-src 'self'; frame-src 'self';"
  </LocationMatch>
</IfModule>

<IfDefine NOINDEX>
  Header always set X-Robots-Tag "noindex, nofollow"
</IfDefine>