name: phaidra

networks:
  phaidra-network:
    ipam:
      config:
        - subnet: 172.29.0.0/16
          ip_range: 172.29.7.0/24
          gateway: 172.29.5.1

services:
  ##############################################################
  ## definitions using images including all code for releases ##
  ## profiles:                                                ##
  ## + demo-local                                             ##
  ## + demo-s3                                                ##
  ## + ssl-local                                              ##
  ## + ssl-s3                                                 ##
  ## + shib-local                                             ##
  ## + shib-s3                                                ##
  ##############################################################

  ############### httpd service for demo-local profile ###############
  httpd-demo-local:
    image: phaidraorg/httpd-demo-dist:143a0b39
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui}"
    profiles: ["demo-local"]

  ############### httpd service for demo-s3 profile ###############
  httpd-demo-s3:
    image: phaidraorg/httpd-demo-dist:143a0b39
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui-s3}"
    profiles: ["demo-s3"]

  #################### httpd service for ssl-local profile ####################
  httpd-ssl-local:
    image: phaidraorg/httpd-ssl-dist:326004fd
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui}"
    profiles: ["ssl-local"]

  #################### httpd service for ssl-s3 profile ####################
  httpd-ssl-s3:
    image: phaidraorg/httpd-ssl-dist:326004fd
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui-s3}"
    profiles: ["ssl-s3"]

  #################### httpd service for shib-local profile ####################
  httpd-shib-local:
    image: phaidraorg/httpd-shib-dist:d762d4b3
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui}"
      SHIB_DISCO_URL: "${SHIB_DISCO_URL:-}"
      SHIB_METADATA_CERT: "${SHIB_METADATA_CERT:-}"
      SHIB_METADATA_FILE: "${SHIB_METADATA_FILE:-}"
      SHIB_METADATA: "${SHIB_METADATA:-}"
      SHIB_ENTITY_ID: "${SHIB_ENTITY_ID:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-local"]

  #################### httpd service for shib-s3 profile ####################
  httpd-shib-s3:
    image: phaidraorg/httpd-shib-dist:d762d4b3
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
      LAM_HOST: "${LAM_HOST:-lam}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      UI_HOST: "${UI_HOST:-ui-s3}"
      SHIB_DISCO_URL: "${SHIB_DISCO_URL:-}"
      SHIB_METADATA_CERT: "${SHIB_METADATA_CERT:-}"
      SHIB_METADATA_FILE: "${SHIB_METADATA_FILE:-}"
      SHIB_METADATA: "${SHIB_METADATA:-}"
      SHIB_ENTITY_ID: "${SHIB_ENTITY_ID:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-s3"]
    
  solr:
    image: phaidraorg/solr-dist:c9f6512f
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - solr:/var/solr
    environment:
      SOLR_SALT: "${SOLR_SALT:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  ############### ui service for local profile ###############
  ui:
    depends_on: [api]
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    image: phaidraorg/ui:c9f6512f
    networks:
      - phaidra-network
    environment:
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#008080}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      PHAIDRA_API_HOST_INTERNAL: "${PHAIDRA_API_HOST:-api}"
    profiles: ["demo-local", "ssl-local", "shib-local"]

  ############### ui service for s3 profile ###############
  ui-s3:
    depends_on: [api-s3]
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    image: phaidraorg/ui:c9f6512f
    networks:
      - phaidra-network
    environment:
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#008080}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      PHAIDRA_API_HOST_INTERNAL: "${PHAIDRA_API_HOST:-api-s3}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  ############### api service for s3 profile ###############
  api-s3:
    depends_on: [mariadb-phaidra, mongodb-phaidra, fedora-s3]
    image: phaidraorg/api-dist:c9f6512f
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - s3_cache:/s3_cache
    networks:
      - phaidra-network
    environment:
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_HASH_SECRET: "${IMAGESERVER_HASH_SECRET:-changeme}"
      IMAGESERVER_HOST: "${IMAGESERVER_HOST:-imageserver-s3}"
      IMAGESERVER_ROOT_PATH: "s3_cache/converted_images"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      MARIADB_PHAIDRA_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      MARIADB_PHAIDRA_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OC_EXTERNAL: "${OC_EXTERNAL:-false}"
      OPENLDAP_HOST: "${OPENLDAP_HOST:-openldap}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_API_HOST: "${PHAIDRA_API_HOST:-api-s3}"
      PHAIDRA_ENCRYPTION_KEY: "${PHAIDRA_ENCRYPTION_KEY:-changeme}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_SECRET: "${PHAIDRA_SECRET:-changeme}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_CACHESIZE: "${S3_CACHESIZE:-100000000}"
      S3_CACHE_TOPDIR: "${S3_CACHE_TOPDIR:-/s3_cache}"
      S3_ENABLED: "${S3_ENABLED:-true}"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_MAIL: "${SHIB_MAIL:-mail}"
      SHIB_REQUIRED_AFFILIATIONS: "${SHIB_REQUIRED_AFFILIATIONS:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  ############### api service for local profile ###############
  api:
    depends_on: [mariadb-phaidra, mongodb-phaidra, fedora]
    image: phaidraorg/api-dist:c9f6512f
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - fedora:/mnt/fedora:ro
    networks:
      - phaidra-network
    environment:
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_HASH_SECRET: "${IMAGESERVER_HASH_SECRET:-changeme}"
      IMAGESERVER_HOST: "${IMAGESERVER_HOST:-imageserver}"
      IMAGESERVER_ROOT_PATH: "/mnt/converted_images"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      MARIADB_PHAIDRA_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      MARIADB_PHAIDRA_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OC_EXTERNAL: "${OC_EXTERNAL:-false}"
      OPENLDAP_HOST: "${OPENLDAP_HOST:-openldap}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_API_HOST: "${PHAIDRA_API_HOST:-api}"
      PHAIDRA_ENCRYPTION_KEY: "${PHAIDRA_ENCRYPTION_KEY:-changeme}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_SECRET: "${PHAIDRA_SECRET:-changeme}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_CACHESIZE: "${S3_CACHESIZE:-100000000}"
      S3_CACHE_TOPDIR: "${S3_CACHE_TOPDIR:-}"
      S3_ENABLED: "${S3_ENABLED:-false}"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_REQUIRED_AFFILIATIONS: "${SHIB_REQUIRED_AFFILIATIONS:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
    profiles: ["demo-local", "ssl-local", "shib-local"]

  ############### pixelgecko service for s3 profile ###############
  pixelgecko-s3:
    depends_on: [mongodb-phaidra, api-s3, fedora-s3]
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    image: phaidraorg/pixelgecko-dist:359ae61c
    networks:
      - phaidra-network
    environment:
      CONVERTED_IMAGES_PATH: "${CONVERTED_IMAGES_PATH:-/converted_images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_ENABLED: "true"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  ############### pixelgecko service for local profile ###############
  pixelgecko:
    depends_on: [mongodb-phaidra, api]
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    image: phaidraorg/pixelgecko-dist:359ae61c
    volumes:
      - fedora:/mnt/fedora:ro
      - pixelgecko:/mnt/converted_images
    networks:
      - phaidra-network
    environment:
      CONVERTED_IMAGES_PATH: "${CONVERTED_IMAGES_PATH:-/mnt/converted_images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_ENABLED: "false"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
    profiles: ["demo-local", "ssl-local", "shib-local"]

  mariadb-phaidra:
    image: phaidraorg/mariadb-phaidra-dist:f21114b6
    restart: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${PHAIDRADB:-phaidradb}"
      MARIADB_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mariadb_phaidra:/var/lib/mysql
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  mariadb-fedora:
    image: phaidraorg/mariadb-fedora-dist:f21114b6
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${FEDORADB:-fedoradb}"
      MARIADB_USER: "${MARIADB_FEDORA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
    volumes:
      - mariadb_fedora:/var/lib/mysql
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  mongodb-phaidra:
    image: phaidraorg/mongodb-dist:10a6b315
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mongodb_phaidra:/data/db
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  dbgate:
    image: dbgate/dbgate:5.2.7
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CONNECTIONS: con1,con2,con3
      LABEL_con1: MariaDB-Phaidra
      SERVER_con1: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      USER_con1: "${MARIADB_PHAIDRA_USER:-phaidra}"
      PASSWORD_con1: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      PORT_con1: 3306
      ENGINE_con1: mariadb@dbgate-plugin-mysql
      LABEL_con2: MariaDB-Fedora
      SERVER_con2: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
      USER_con2: "${MARIADB_FEDORA_USER:-phaidra}"
      PASSWORD_con2: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      PORT_con2: 3306
      ENGINE_con2: mariadb@dbgate-plugin-mysql
      LABEL_con3: MongoDB-Phaidra
      URL_con3: "mongodb://${MONGODB_PHAIDRA_USER:-phaidra}:${MONGODB_PHAIDRA_PASSWORD:-phaidra}@${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}:27017"
      ENGINE_con3: mongo@dbgate-plugin-mongo
      WEB_ROOT: /dbgate
      LOGINS: phaidra
      LOGIN_PASSWORD_phaidra: "${DBGATE_PASS:-phaidra}"
    volumes:
      - dbgate:/root/.dbgate
    depends_on: [mariadb-phaidra, mariadb-fedora, mongodb-phaidra]
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]


  ############### chronos service for local profile ###############
  chronos:
    image: phaidraorg/chronos-dist:6df181be
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
    environment:
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora}"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB:-:}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
    depends_on: [mariadb-fedora, mariadb-phaidra, mongodb-phaidra, fedora]
    networks:
      - phaidra-network
    profiles: ["demo-local", "ssl-local", "shib-local"]

  ############### chronos service for s3 profile ###############
  chronos-s3:
    image: phaidraorg/chronos-dist:6df181be
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
    environment:
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3}"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      SOLR_HOST: "${SOLR_HOST:-solr}"
    depends_on: [mariadb-fedora, mariadb-phaidra, mongodb-phaidra, fedora-s3]
    networks:
      - phaidra-network
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  promtail:
    image: phaidraorg/promtail-dist:17fb62e1
    restart: always
    volumes:
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yaml -config.expand-env=true
    networks:
      - phaidra-network
    environment:
      LOKI_HOST: "loki"
    depends_on: [grafana, loki]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  loki:
    image: phaidraorg/loki-dist:0b27f01e
    restart: always
    volumes:
      - loki:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  grafana:
    image: phaidraorg/grafana-dist:32b5939f
    restart: always
    volumes:
      - grafana:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: "${GF_SECURITY_ADMIN_USER:-phaidra}"
      GF_SECURITY_ADMIN_PASSWORD: "${GF_SECURITY_ADMIN_PASSWORD:-phaidra}"
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/mnt/grafana/dashboards/phaidra_default.json"
      LOKI_HOST: "loki"
      PROMETHEUS_HOST: "prometheus"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
    depends_on: [loki]
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  prometheus:
    image: phaidraorg/prometheus-dist:343ee951
    restart: always
    volumes:
      - prometheus:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  vige:
    image: phaidraorg/vige-dist:0fa040be
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - vige:/opt/vige
      - fedora:/mnt/fedora:ro
      - vige-mongosh:/root/.mongodb
    networks:
      - phaidra-network
    depends_on: [mongodb-phaidra]
    environment:
      OC_EVENTS_URL: "${OC_EVENTS_URL:-}"
      OC_INGEST_URL: "${OC_INGEST_URL:-}"
      OC_USER: "${OC_USER:-}"
      OC_PASS: "${OC_PASS:-}"
      OC_WORKFLOW: "${OC_WORKFLOW:-}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      M_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      M_PASS: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      M_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
    profiles: ["external-opencast"]

  vige-dev:
    image: phaidraorg/vige-base:latest
    pull_policy: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - ./src/vige:/mnt/vige:ro
      - vige:/opt/vige
      - fedora:/mnt/fedora:ro
      - vige-mongosh:/root/.mongodb
    networks:
      - phaidra-network
    depends_on: [mongodb-phaidra-dev]
    environment:
      OC_EVENTS_URL: "${OC_EVENTS_URL:-}"
      OC_INGEST_URL: "${OC_INGEST_URL:-}"
      OC_USER: "${OC_USER:-}"
      OC_PASS: "${OC_PASS:-}"
      OC_WORKFLOW: "${OC_WORKFLOW:-}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      M_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      M_PASS: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      M_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
    profiles: ["external-opencast-dev"]

  ##############################################################
  ##### definitions for self-contained services            #####
  ##### used by profiles:                                  #####
  ##### + demo-local                                       #####
  ##### + demo-s3                                          #####
  ##### + ssl-local                                        #####
  ##### + demo-local-dev                                   #####
  ##### + shib-local-dev                                   #####    
  ##############################################################

  ############### imageserver service for local profiles ##############
  imageserver:
    image: phaidraorg/imageserver:77403e3a
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - pixelgecko:/mnt/converted_images:ro
    networks:
      - phaidra-network
    profiles: ["demo-local", "ssl-local", "shib-local", "demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  ############### imageserver service for s3 profiles #################
  imageserver-s3:
    image: phaidraorg/imageserver:77403e3a
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - s3_cache:/s3_cache:ro
    networks:
      - phaidra-network
    profiles: ["demo-s3", "ssl-s3", "shib-s3", "demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############## fedora service for local profile ###############
  fedora:
    image: fcrepo/fcrepo:6.4.1
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CATALINA_OPTS: "-Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora}:3306/${FEDORADB:-fedoradb} -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra} -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}"
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora]
    volumes:
      - fedora:/usr/local/tomcat/fcrepo-home
    networks:
      - phaidra-network
    profiles: ["demo-local", "ssl-local", "shib-local"]

  ############## fedora service for local dev profile ###############
  fedora-local-dev:
    image: fcrepo/fcrepo:6.4.1
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CATALINA_OPTS: "-Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}:3306/${FEDORADB:-fedoradb} -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra} -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}"
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora-dev]
    volumes:
      - fedora:/usr/local/tomcat/fcrepo-home
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  ############## fedora service for s3 dev profile ###############
  fedora-s3-dev:
    image: fcrepo/fcrepo:6.4.1
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CATALINA_OPTS: "-Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}:3306/${FEDORADB:-fedoradb} -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra} -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra} -Dfcrepo.storage=ocfl-s3 -Dfcrepo.aws.region=${S3_REGION} -Dfcrepo.ocfl.s3.bucket=${S3_BUCKETNAME} -Dfcrepo.aws.access-key=${S3_ACCESS_KEY} -Dfcrepo.aws.secret-key=${S3_SECRET_KEY} -Dfcrepo.ocfl.s3.prefix=fedora"
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora-dev]
    networks:
      - phaidra-network
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

    
  ############### fedora service for s3 profiles ###############
  fedora-s3:
    image: fcrepo/fcrepo:6.4.1
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CATALINA_OPTS: "-Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora}:3306/${FEDORADB:-fedoradb} -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra} -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra} -Dfcrepo.storage=ocfl-s3 -Dfcrepo.aws.region=${S3_REGION} -Dfcrepo.ocfl.s3.bucket=${S3_BUCKETNAME} -Dfcrepo.aws.access-key=${S3_ACCESS_KEY} -Dfcrepo.aws.secret-key=${S3_SECRET_KEY} -Dfcrepo.ocfl.s3.prefix=fedora"
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora]
    networks:
      - phaidra-network
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  lam:
    image: ghcr.io/ldapaccountmanager/lam:8.5
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      LDAP_DOMAIN: "${LDAP_SLD:-example}.${LDAP_TLD:-org}"
      LDAP_SERVER: "${LDAP_PROTOCOL:-ldap}://${LDAP_HOSTNAME:-openldap}:${LDAP_PORT_NUMBER:-1389}"
      LDAP_USER: "cn=${LDAP_ADMIN_USERNAME:-admin},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_USERS_DN: "ou=${LDAP_USERS_OU:-people},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_GROUPS_DN: "ou=${LDAP_GROUPS_OU:-groups},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
    depends_on: [openldap]
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  lam-dev:
    image: ghcr.io/ldapaccountmanager/lam:8.5
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      LDAP_DOMAIN: "${LDAP_SLD:-example}.${LDAP_TLD:-org}"
      LDAP_SERVER: "${LDAP_PROTOCOL:-ldap}://${LDAP_HOSTNAME:-openldap-dev}:${LDAP_PORT_NUMBER:-1389}"
      LDAP_USER: "cn=${LDAP_ADMIN_USERNAME:-admin},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_USERS_DN: "ou=${LDAP_USERS_OU:-people},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_GROUPS_DN: "ou=${LDAP_GROUPS_OU:-groups},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
    depends_on: [openldap-dev]
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]
    
  openldap:
    image: phaidraorg/openldap-dist:10a6b315
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_PORT_NUMBER: "${LDAP_PORT_NUMBER:-1389}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_CUSTOM_LDIF_DIR: "/ldifs"
    volumes:
      - openldap:/bitnami/openldap
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  openldap-dev:
    image: bitnami/openldap:2.6.6-debian-11-r59
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_PORT_NUMBER: "${LDAP_PORT_NUMBER:-1389}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_CUSTOM_LDIF_DIR: "/ldifs"
    volumes:
      - openldap:/bitnami/openldap
      - ./container_init/openldap/init.ldif:/ldifs/init.ldif:ro
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

    
  # retrieves host memory usage (scraped by prometheus)
  node-exporter:
    image: prom/node-exporter:v1.8.1
    restart: always
    networks:
      - phaidra-network
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  # retrieves container metrics (scraped by prometheus)
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    restart: always
    networks:
      - phaidra-network
    volumes:
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /etc/machine-id:/etc/machine-id:ro
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ##############################################################
  ##### definitions bindmounting repo code for development #####
  ##### profiles:                                          #####
  ##### + website                                          #####
  ##### + demo-local-dev                                        #####
  ##############################################################
  mkdocs:
    image: squidfunk/mkdocs-material:latest
    hostname: mkdocs
    pull_policy: always
    # use build to build static files locally (within /site dir) which then can be pushed to server
    # command: "build"
    command: "serve --dev-addr=0.0.0.0:8000"
    volumes:
      - ./:/docs
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    profiles: ["website"]

  httpd-demo-local-dev:
    image: httpd:2.4.62-bookworm
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - ./container_init/httpd/phaidra-demo:/mnt/startup:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-local-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-local-dev}"
    entrypoint: [ "bash", "/mnt/startup/httpd-demo-startup.bash" ]
    profiles: ["demo-local-dev"]

  ui-local-dev:
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    build:
      context: .
      dockerfile: dockerfiles/ui.dockerfile
    networks:
      - phaidra-network
    environment:
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#008080}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      PHAIDRA_API_HOST_INTERNAL: "${PHAIDRA_API_HOST:-api-local-dev}"
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  api-local-dev:
    image: phaidraorg/api-base:latest
    pull_policy: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - fedora:/mnt/fedora:ro
      - ./src/phaidra-api:/usr/local/phaidra/phaidra-api:ro
      - ./container_init/api/api-entrypoint.bash:/mnt/api-entrypoint.bash:ro
    networks:
      - phaidra-network
    environment:
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_HASH_SECRET: "${IMAGESERVER_HASH_SECRET:-changeme}"
      IMAGESERVER_HOST: "${IMAGESERVER_HOST:-imageserver}"
      IMAGESERVER_ROOT_PATH: "/mnt/converted_images"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      MARIADB_PHAIDRA_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      MARIADB_PHAIDRA_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OC_EXTERNAL: "${OC_EXTERNAL:-false}"
      OPENLDAP_HOST: "${OPENLDAP_HOST:-openldap-dev}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_API_HOST: "${PHAIDRA_API_HOST:-api-local-dev}"
      PHAIDRA_ENCRYPTION_KEY: "${PHAIDRA_ENCRYPTION_KEY:-changeme}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_SECRET: "${PHAIDRA_SECRET:-changeme}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_CACHESIZE: "${S3_CACHESIZE:-100000000}"
      S3_CACHE_TOPDIR: "${S3_CACHE_TOPDIR:-}"
      S3_ENABLED: "false"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_REQUIRED_AFFILIATIONS: "${SHIB_REQUIRED_AFFILIATIONS:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
    entrypoint: [ "bash", "/mnt/api-entrypoint.bash" ]
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  pixelgecko-local-dev:
    image: phaidraorg/pixelgecko-base:latest
    pull_policy: always
    restart: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    volumes:
      - fedora:/mnt/fedora:ro
      - pixelgecko:/mnt/converted_images
      - ./src/pixelgecko:/opt/pixelgecko:ro
    networks:
      - phaidra-network
    environment:
      CONVERTED_IMAGES_PATH: "${CONVERTED_IMAGES_PATH:-/mnt/converted_images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_ENABLED: "false"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  mariadb-phaidra-dev:
    image: mariadb:11.0.2-jammy
    restart: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${PHAIDRADB:-phaidradb}"
      MARIADB_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - ./container_init/mariadb/phaidradb:/docker-entrypoint-initdb.d:ro
      - mariadb_phaidra:/var/lib/mysql
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  mariadb-fedora-dev:
    image: mariadb:10.5
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${FEDORADB:-fedoradb}"
      MARIADB_USER: "${MARIADB_FEDORA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
    volumes:
      - ./container_init/mariadb/fedoradb/fedoradb_grafana.sql:/docker-entrypoint-initdb.d/fedoradb_grafana.sql:ro
      - mariadb_fedora:/var/lib/mysql
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  mongodb-phaidra-dev:
    image: mongo:5
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mongodb_phaidra:/data/db
      - .././container_init/mongodb/init_oai_sets.json:/mnt/init_oai_sets.json:ro
      - .././container_init/mongodb/mongodb-after-entry.sh:/docker-entrypoint-initdb.d/mongodb-after-entry.sh:ro
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  dbgate-dev:
    image: dbgate/dbgate:5.2.7
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    environment:
      CONNECTIONS: con1,con2,con3
      LABEL_con1: MariaDB-Phaidra
      SERVER_con1: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      USER_con1: "${MARIADB_PHAIDRA_USER:-phaidra}"
      PASSWORD_con1: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      PORT_con1: 3306
      ENGINE_con1: mariadb@dbgate-plugin-mysql
      LABEL_con2: MariaDB-Fedora
      SERVER_con2: "${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}"
      USER_con2: "${MARIADB_FEDORA_USER:-phaidra}"
      PASSWORD_con2: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      PORT_con2: 3306
      ENGINE_con2: mariadb@dbgate-plugin-mysql
      LABEL_con3: MongoDB-Phaidra
      URL_con3: "mongodb://${MONGODB_PHAIDRA_USER:-phaidra}:${MONGODB_PHAIDRA_PASSWORD:-phaidra}@${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}:27017"
      ENGINE_con3: mongo@dbgate-plugin-mongo
      WEB_ROOT: /dbgate
      LOGINS: phaidra
      LOGIN_PASSWORD_phaidra: "${DBGATE_PASS:-phaidra}"
    volumes:
      - dbgate:/root/.dbgate
    depends_on: [mariadb-phaidra-dev, mariadb-fedora-dev, mongodb-phaidra-dev]
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  chronos-dev:
    image: phaidraorg/chronos-base:latest
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    pull_policy: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - ./container_init/chronos:/mnt/chronos:ro
    environment:
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB:-:}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
    depends_on: [mariadb-fedora-dev, mariadb-phaidra-dev, mongodb-phaidra-dev, fedora-local-dev]
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  solr-dev:
    image: solr:9.6.1
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - solr:/var/solr
      - ./container_init/solr:/mnt/solr:ro
    environment:
      SOLR_SALT: "${SOLR_SALT:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
    networks:
      - phaidra-network
    entrypoint: ["bash", "/mnt/solr/solr_entrypoint.bash"]
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  grafana-dev:
    image: grafana/grafana:11.0.0
    restart: always
    volumes:
      - ./container_init/grafana/ds.yaml:/etc/grafana/provisioning/datasources/ds.yaml:ro
      - ./container_init/grafana/dd.yaml:/etc/grafana/provisioning/dashboards/dd.yaml:ro
      - ./container_init/grafana/dashboards:/mnt/grafana/dashboards:ro
      - grafana:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: "${GF_SECURITY_ADMIN_USER:-phaidra}"
      GF_SECURITY_ADMIN_PASSWORD: "${GF_SECURITY_ADMIN_PASSWORD:-phaidra}"
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/mnt/grafana/dashboards/phaidra_default.json"
      LOKI_HOST: "loki-dev"
      PROMETHEUS_HOST: "prometheus-dev"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
    depends_on: [loki-dev]
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  loki-dev:
    image: grafana/loki:3.0.0
    restart: always
    volumes:
      - ./container_init/loki/loki-docker-config.yaml:/etc/loki/local-config.yaml:ro
      - loki:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  promtail-dev:
    image: grafana/promtail:3.0.0
    restart: always
    volumes:
      - ./container_init/promtail/promtail-local-config.yaml:/etc/promtail/config.yaml:ro
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    environment:
      LOKI_HOST: "loki-dev"
    command: -config.file=/etc/promtail/config.yaml -config.expand-env=true
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  prometheus-dev:
    image: prom/prometheus:v2.52.0
    restart: always
    volumes:
      - ./container_init/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - prometheus:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - phaidra-network
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  #################### demo-s3-dev ####################
  httpd-demo-s3-dev:
    image: httpd:2.4.62-bookworm
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - ./container_init/httpd/phaidra-demo:/mnt/startup:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-s3-dev}"
    entrypoint: [ "bash", "/mnt/startup/httpd-demo-startup.bash" ]
    profiles: ["demo-s3-dev"]

  api-s3-dev:
    image: phaidraorg/api-base:latest
    pull_policy: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    volumes:
      - s3_cache:/s3_cache
      - ./src/phaidra-api:/usr/local/phaidra/phaidra-api:ro
      - ./container_init/api/api-entrypoint.bash:/mnt/api-entrypoint.bash:ro
    networks:
      - phaidra-network
    environment:
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_HASH_SECRET: "${IMAGESERVER_HASH_SECRET:-changeme}"
      IMAGESERVER_HOST: "${IMAGESERVER_HOST:-imageserver-s3}"
      IMAGESERVER_ROOT_PATH: "s3_cache/converted_images"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      MARIADB_PHAIDRA_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      MARIADB_PHAIDRA_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OC_EXTERNAL: "${OC_EXTERNAL:-false}"
      OPENLDAP_HOST: "${OPENLDAP_HOST:-openldap-dev}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_API_HOST: "${PHAIDRA_API_HOST:-api-s3-dev}"
      PHAIDRA_ENCRYPTION_KEY: "${PHAIDRA_ENCRYPTION_KEY:-changeme}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_SECRET: "${PHAIDRA_SECRET:-changeme}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_CACHESIZE: "${S3_CACHESIZE:-100000000}"
      S3_CACHE_TOPDIR: "${S3_CACHE_TOPDIR:-/s3_cache}"
      S3_ENABLED: "true"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_MAIL: "${SHIB_MAIL:-mail}"
      SHIB_REQUIRED_AFFILIATIONS: "${SHIB_REQUIRED_AFFILIATIONS:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
    entrypoint: [ "bash", "/mnt/api-entrypoint.bash" ]
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]
  
  ui-s3-dev:
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    build:
      context: .
      dockerfile: dockerfiles/ui.dockerfile
    networks:
      - phaidra-network
    environment:
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#008080}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      PHAIDRA_API_HOST_INTERNAL: "${PHAIDRA_API_HOST:-api-s3-dev}"
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]
  
  chronos-s3-dev:
    image: phaidraorg/chronos-base:latest
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    pull_policy: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - ./container_init/chronos:/mnt/chronos:ro
    environment:
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-8899}"
      PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB:-:}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
    depends_on: [mariadb-fedora-dev, mariadb-phaidra-dev, mongodb-phaidra-dev, fedora-s3-dev]
    networks:
      - phaidra-network
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]
  
  pixelgecko-s3-dev:
    depends_on: [mongodb-phaidra-dev, api-s3-dev, fedora-s3-dev]
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    image: phaidraorg/pixelgecko-base:latest
    pull_policy: always
    volumes:
      - ./src/pixelgecko:/opt/pixelgecko:ro
    networks:
      - phaidra-network
    environment:
      CONVERTED_IMAGES_PATH: "${CONVERTED_IMAGES_PATH:-/converted_images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY:-}"
      S3_BUCKETNAME: "${S3_BUCKETNAME:-}"
      S3_ENABLED: "true"
      S3_SECRET_KEY: "${S3_SECRET_KEY:-}"
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  #################### ssl-local-dev ####################
  httpd-ssl-local-dev:
    image: httpd:2.4.62-bookworm
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./container_init/httpd/phaidra-ssl/conf/phaidra-ssl.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-ssl/httpd-ssl-entrypoint.bash:/httpd-ssl-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-local-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-local-dev}"
    entrypoint: [ "bash", "/httpd-ssl-entrypoint.bash" ]
    profiles: ["ssl-local-dev"]

  #################### ssl-s3-dev ####################
  httpd-ssl-s3-dev:
    image: httpd:2.4.62-bookworm
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./container_init/httpd/phaidra-ssl/conf/phaidra-ssl.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-ssl/httpd-ssl-entrypoint.bash:/httpd-ssl-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-s3-dev}"
    entrypoint: [ "bash", "/httpd-ssl-entrypoint.bash" ]
    profiles: ["ssl-s3-dev"]

  #################### shib-local-dev ####################
  httpd-shib-local-dev:
    image: phaidraorg/httpd-shib-base:latest
    pull_policy: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - ./container_init/httpd/phaidra-shib/conf:/shib-init:ro
      - ./container_init/httpd/phaidra-shib/conf/phaidra-shib.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-shib/httpd-shib-entrypoint.bash:/httpd-shib-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-local-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-local-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-local-dev}"
      SHIB_DISCO_URL: "${SHIB_DISCO_URL:-}"
      SHIB_METADATA_CERT: "${SHIB_METADATA_CERT:-}"
      SHIB_METADATA_FILE: "${SHIB_METADATA_FILE:-}"
      SHIB_METADATA: "${SHIB_METADATA:-}"
      SHIB_ENTITY_ID: "${SHIB_ENTITY_ID:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-local-dev"]

  #################### shib-s3-dev ####################
  httpd-shib-s3-dev:
    image: phaidraorg/httpd-shib-base:latest
    pull_policy: always
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - ./container_init/httpd/phaidra-shib/conf:/shib-init:ro
      - ./container_init/httpd/phaidra-shib/conf/phaidra-shib.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-shib/httpd-shib-entrypoint.bash:/httpd-shib-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
    networks:
      - phaidra-network
    environment:
      ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
      API_HOST: "${PHAIDRA_API_HOST:-api-s3-dev}"
      DBGATE_HOST: "${DBGATE_HOST:-dbgate-dev}"
      FEDORA_HOST: "${FEDORA_HOST:-fedora-s3-dev}"
      GRAFANA_HOST: "${GRAFANA_HOST:-grafana-dev}"
      LAM_HOST: "${LAM_HOST:-lam-dev}"
      PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-}"
      PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT:-}"
      SOLR_HOST: "${SOLR_HOST:-solr-dev}"
      UI_HOST: "${UI_HOST:-ui-s3-dev}"
      SHIB_DISCO_URL: "${SHIB_DISCO_URL:-}"
      SHIB_METADATA_CERT: "${SHIB_METADATA_CERT:-}"
      SHIB_METADATA_FILE: "${SHIB_METADATA_FILE:-}"
      SHIB_METADATA: "${SHIB_METADATA:-}"
      SHIB_ENTITY_ID: "${SHIB_ENTITY_ID:-}"
      SHIB_MAIL: "${SHIB_MAIL:-}"
      SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
      SHIB_SURNAME: "${SHIB_SURNAME:-}"
      SHIB_USERNAME: "${SHIB_USERNAME:-}"
      SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-s3-dev"]
    
volumes:
  chronos-database-dumps:
  chronos-oai-logs:
  chronos-sitemaps:
  dbgate:
  fedora:
  grafana:
  loki:
  mariadb_fedora:
  mariadb_phaidra:
  mongodb_phaidra:
  openldap:
  pixelgecko:
  prometheus:
  s3_cache:
  solr:
  vige-mongosh:
  vige:
