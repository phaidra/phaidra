name: phaidra

networks:
  phaidra-network:
    ipam:
      config:
        - subnet: 172.29.0.0/16
          ip_range: 172.29.7.0/24
          gateway: 172.29.5.1

# see https://docs.docker.com/reference/compose-file/extension/
x-custom:
  imageserver_env: &imageserver_env
    MAX_IMAGE_CACHE_SIZE: 1000 #1G image cache. probably want to reduce this when using varnish
    VERBOSITY: "10"
    LIGHTTPD_PORT: 80
    BASE_URL: "${OUTSIDE_HTTP_SCHEME}://${PHAIDRA_HOSTNAME}${PHAIDRA_PORTSTUB}${PHAIDRA_HOSTPORT}/api/imageserver?IIIF="
    FILESYSTEM_PREFIX: "/"
  common: &common
    restart: always
    networks:
      - phaidra-network

  logs: &logs
    labels:
      logging: "promtail"
      logging_jobname: "containerlogs"

  s3: &s3
    S3_ACCESS_KEY: "${S3_ACCESS_KEY:-phaidra}"
    S3_BUCKETNAME: "${S3_BUCKETNAME:-phaidra-bucket}"
    S3_CACHESIZE: "${S3_CACHESIZE:-100000000}"
    S3_CACHE_TOPDIR: "${S3_CACHE_TOPDIR:-/s3-cache}"
    S3_ENABLED: "true"
    S3_ENDPOINT: "${S3_ENDPOINT:-http://minio:9000}"
    S3_SECRET_KEY: "${S3_SECRET_KEY:-phaidraphaidra}"

  httpd_env: &httpd_env
    UI_REQUIRE: "${UI_REQUIRE:-Require all granted}"
    HTTPD_ACME_ENABLE: "${HTTPD_ACME_ENABLE:-false}"
    HTTPD_ACME_EAB_ENABLE: "${HTTPD_ACME_EAB_ENABLE:-false}"
    HTTPD_ACME_KEYID: "${HTTPD_ACME_KEYID:-}"
    HTTPD_ACME_HMAC64: "${HTTPD_ACME_HMAC64:-}"
    CA_ENDPOINT: "${CA_ENDPOINT:-LetsEncrypt-Test}"
    MD_CERTIFICATE_AGREEMENT: "${MD_CERTIFICATE_AGREEMENT?}"
    HTTPD_PFSA_ENABLE: "${HTTPD_PFSA_ENABLE:-false}"
    HTTPD_PFSA_REDIRECT_FQDN: "${HTTPD_PFSA_REDIRECT_FQDN:-}"
    HTTPD_NOINDEX_ENABLE: "${HTTPD_NOINDEX_ENABLE:-false}"

  shib_env: &shib_env
    SHIB_DISCO_URL: "${SHIB_DISCO_URL:-}"
    SHIB_METADATA_CERT: "${SHIB_METADATA_CERT:-}"
    SHIB_METADATA_FILE: "${SHIB_METADATA_FILE:-}"
    SHIB_METADATA: "${SHIB_METADATA:-}"
    SHIB_ENTITY_ID: "${SHIB_ENTITY_ID:-}"
    SHIB_MAIL: "${SHIB_MAIL:-}"
    SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
    SHIB_SURNAME: "${SHIB_SURNAME:-}"
    SHIB_USERNAME: "${SHIB_USERNAME:-}"
    SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"

  api_common_env: &api_common_env
    FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
    FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
    IMAGESERVER_HASH_SECRET: "${IMAGESERVER_HASH_SECRET:-changeme}"
    LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
    LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
    LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
    MARIADB_PHAIDRA_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
    MARIADB_PHAIDRA_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
    MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
    MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
    OC_EXTERNAL: "${OC_EXTERNAL:-false}"
    OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
    PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
    PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
    PHAIDRA_ENCRYPTION_KEY: "${PHAIDRA_ENCRYPTION_KEY:-changeme}"
    PHAIDRA_HOSTNAME: "${PHAIDRA_HOSTNAME:-localhost}"
    PHAIDRA_HOSTPORT: "${PHAIDRA_HOSTPORT-8899}"
    PHAIDRA_PORTSTUB: "${PHAIDRA_PORTSTUB-:}"
    PHAIDRA_SECRET: "${PHAIDRA_SECRET:-changeme}"
    SHIB_AFFILIATION: "${SHIB_AFFILIATION:-}"
    SHIB_GIVEN_NAME: "${SHIB_GIVEN_NAME:-}"
    SHIB_REQUIRED_AFFILIATIONS: "${SHIB_REQUIRED_AFFILIATIONS:-}"
    SHIB_SUPERUSER_AFFILIATION: "${SHIB_SUPERUSER_AFFILIATION:-}"
    SHIB_SURNAME: "${SHIB_SURNAME:-}"
    SHIB_USERNAME: "${SHIB_USERNAME:-}"
    SOLR_PASS: "${SOLR_PASS:-phaidra}"
    SOLR_USER: "${SOLR_USER:-phaidra}"
    PHAIDRA_ADMIN_EMAIL: "${PHAIDRA_ADMIN_EMAIL:?}"
    MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
    MARIADB_FEDORA_USER: "${MARIADB_FEDORA_USER:-phaidra}"
    MARIADB_FEDORA_PASSWORD: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
    PHAIDRA_API_WORKER: "${PHAIDRA_API_WORKER:-16}"

  configs: &configs
    configs:
      - source: httpd_custom_config
        target: "/usr/local/apache2/conf/httpd_custom.conf"
      - source: shibboleth_attribute_map
        target: /shib-init/attribute-map.xml
      - source: shibboleth_attribute_policy
        target: /shib-init/attribute-policy.xml

  hosts: &hosts
    ADMIN_IP_LIST: "${ADMIN_IP_LIST:-10.0.2.2}"
    PHAIDRA_API_HOST: "${PHAIDRA_API_HOST:-api}"
    API_HOST: "${PHAIDRA_API_HOST:-api}"
    PHAIDRA_API_HOST_INTERNAL: "${PHAIDRA_API_HOST:-api}"
    DBGATE_HOST: "${DBGATE_HOST:-dbgate}"
    FEDORA_HOST: "${FEDORA_HOST:-fedora}"
    GRAFANA_HOST: "${GRAFANA_HOST:-grafana}"
    IMAGESERVER_HOST: "${IMAGESERVER_HOST:-imageserver}"
    LAM_HOST: "${LAM_HOST:-lam}"
    LOKI_HOST: "loki"
    MARIADB_FEDORA_HOST: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
    MARIADB_PHAIDRA_HOST: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
    MONGODB_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
    MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
    OPENLDAP_HOST: "${OPENLDAP_HOST:-openldap}"
    PROMETHEUS_HOST: "prometheus"
    SOLR_HOST: "${SOLR_HOST:-solr}"
    UI_HOST: "${UI_HOST:-ui}"
    VARNISH_HOST: "${VARNISH_HOST:-varnish}"
    HANDLE_HOST: "${HANDLE_HOST:-handle}"

services:
  ############### varnish ###############
  varnish:
    <<: [*common, *logs]
    image: varnish:8
    hostname: varnish
    tmpfs:
      - /var/lib/varnish/varnishd:exec
    configs:
      - source: varnish_config
        target: /etc/varnish/default.vcl
    command:
      - varnishd
      - -F
      - -a
      - :80
      - -f
      - /etc/varnish/default.vcl
      - -s
      - Transient=malloc,${VARNISH_TRANSIENT_SIZE:-1G}
      - -s
      - malloc,${VARNISH_CACHE_SIZE:-2G}
      - -p
      # otherwise varnish tries to preload the whole content into storage
      - transit_buffer=${VARNISH_TRANSIT_SIZE:-128K}
      - -p
      # approximation: allows download of 30G with currently set max speed in httpd (1024K): (30G*1024M)s
      - send_timeout=${VARNISH_SEND_TIMEOUT:-30750s}
    deploy:
      resources:
        limits:
          memory: ${VARNISH_MEMORY_LIMIT:-4G}
    environment:
      <<: [*api_common_env, *hosts]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### httpd ###############
  httpd-demo-local:
    hostname: "httpd"
    image: phaidraorg/httpd-demo-dist:f795202a
    <<: [*common, *logs]
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./static:/mnt/static:ro
    environment:
      <<: [*httpd_env, *api_common_env, *hosts]
    profiles: ["demo-local"]

  httpd-demo-s3:
    hostname: "httpd"
    image: phaidraorg/httpd-demo-dist:f795202a
    <<: [*common, *logs]
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./static:/mnt/static:ro
    environment:
      <<: [*httpd_env, *api_common_env, *hosts]
    profiles: ["demo-s3"]

  httpd-ssl-local:
    hostname: "httpd"
    image: phaidraorg/httpd-ssl-dist:ec56cd52
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
      - ./pfsa:/mnt/pfsa:ro
    environment:
      <<: [*httpd_env, *api_common_env, *hosts]
    profiles: ["ssl-local"]

  httpd-ssl-s3:
    hostname: "httpd"
    image: phaidraorg/httpd-ssl-dist:ec56cd52
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
    environment:
      <<: [*httpd_env, *api_common_env, *hosts]
    profiles: ["ssl-s3"]

  httpd-shib-local:
    hostname: "httpd"
    image: phaidraorg/httpd-shib-dist:ec56cd52
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
      - ./pfsa:/mnt/pfsa:ro
    environment:
      <<: [*shib_env, *httpd_env, *api_common_env, *hosts]
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-local"]

  httpd-shib-s3:
    hostname: "httpd"
    image: phaidraorg/httpd-shib-dist:ec56cd52
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
    environment:
      <<: [*shib_env, *httpd_env, *api_common_env, *hosts]
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-s3"]

  httpd-demo-local-dev:
    hostname: "httpd"
    image: httpd:2.4.66-trixie
    <<: [*common, *logs]
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - ./container_init/httpd/phaidra-demo:/mnt/startup:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./static:/mnt/static:ro
    configs:
      - source: httpd_custom_config
        target: "/usr/local/apache2/conf/httpd_custom.conf"
    environment:
      <<: [*api_common_env, *hosts]
      UI_REQUIRE: "${UI_REQUIRE:-Require all granted}"
    entrypoint: [ "bash", "/mnt/startup/httpd-demo-entrypoint.bash" ]
    profiles: ["demo-local-dev"]

  httpd-demo-s3-dev:
    hostname: "httpd"
    image: httpd:2.4.66-trixie
    <<: [*common, *logs]
    ports:
      - "${PHAIDRA_HOSTPORT:-8899}:80"
    volumes:
      - ./container_init/httpd/phaidra-demo:/mnt/startup:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
      - ./static:/mnt/static:ro
    environment:
      <<: [*api_common_env, *hosts]
      UI_REQUIRE: "${UI_REQUIRE:-Require all granted}"
    entrypoint: [ "bash", "/mnt/startup/httpd-demo-entrypoint.bash" ]
    profiles: ["demo-s3-dev"]

  httpd-ssl-dev:
    hostname: "httpd"
    image: httpd:2.4.66-trixie
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./container_init/httpd/phaidra-ssl/conf/phaidra-ssl.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-ssl/httpd-ssl-entrypoint.bash:/httpd-ssl-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
    environment:
      <<: [*httpd_env, *api_common_env, *hosts]
    entrypoint: [ "bash", "/httpd-ssl-entrypoint.bash" ]
    profiles: ["ssl-local-dev", "ssl-s3-dev"]

  httpd-shib-dev:
    hostname: "httpd"
    image: phaidraorg/httpd-shib-base:latest
    pull_policy: always
    <<: [*common, *logs, *configs]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs/httpd:/ssl:ro
      - ./certs/shibboleth:/shibboleth-certs:ro
      - ./container_init/httpd/phaidra-shib/conf:/shib-init:ro
      - ./container_init/httpd/phaidra-shib/conf/phaidra-shib.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./container_init/httpd/phaidra-shib/httpd-shib-entrypoint.bash:/httpd-shib-entrypoint.bash:ro
      - chronos-sitemaps:/mnt/sitemaps:ro
      - mdcerts:/mnt/mdcerts:rw
      - ./static:/mnt/static:ro
    environment:
      <<: [*shib_env, *httpd_env, *api_common_env, *hosts]
    entrypoint: [ "bash", "/httpd-shib-entrypoint.bash" ]
    profiles: ["shib-local-dev", "shib-s3-dev"]
    
  ############### solr ###############
  solr:
    image: phaidraorg/solr-dist:05cc73e4
    <<: [*common, *logs]
    volumes:
      - solr:/var/solr
      - chronos-database-dumps:/mnt/database-dumps
    environment:
      <<: [*api_common_env, *hosts]
      SOLR_SALT: "${SOLR_SALT:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  solr-dev:
    hostname: "solr"
    image: solr:9.10.1
    <<: [*common, *logs]
    volumes:
      - solr:/var/solr
      - chronos-database-dumps:/mnt/database-dumps
      - ./container_init/solr:/mnt/solr:ro
    environment:
      <<: [*api_common_env, *hosts]
      SOLR_SALT: "${SOLR_SALT:-phaidra}"
      SOLR_USER: "${SOLR_USER:-phaidra}"
      SOLR_PASS: "${SOLR_PASS:-phaidra}"
    entrypoint: ["bash", "/mnt/solr/solr_entrypoint.bash"]
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### ui ###############
  ui:
    hostname: "ui"
    depends_on: [api]
    <<: [*common, *logs]
    image: phaidraorg/ui:0de39c9e
    command: ["pm2-runtime", "start", "ecosystem.config.js"]
    environment:
      <<: [*api_common_env, *hosts]
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_DEFAULT_THEME: "${PHAIDRA_DEFAULT_THEME:-light}"
      PHAIDRA_DARK_PRIMARY_COLOR: "${PHAIDRA_DARK_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      LEGACY_OPEN_REDIRECT: "${LEGACY_OPEN_REDIRECT:-false}"
      IR_BASE_URL: "${IR_BASE_URL:-}"
      COOKIE_DOMAIN: "${COOKIE_DOMAIN:-}"
    profiles: ["demo-local", "ssl-local", "shib-local"]

  ui-s3:
    hostname: "ui"
    depends_on: [api-s3]
    <<: [*common, *logs]
    image: phaidraorg/ui:0de39c9e
    command: ["pm2-runtime", "start", "ecosystem.config.js"]
    environment:
      <<: [*api_common_env, *hosts]
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRA_DEFAULT_THEME: "${PHAIDRA_DEFAULT_THEME:-light}"
      PHAIDRA_DARK_PRIMARY_COLOR: "${PHAIDRA_DARK_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      LEGACY_OPEN_REDIRECT: "${LEGACY_OPEN_REDIRECT:-false}"
      IR_BASE_URL: "${IR_BASE_URL:-}"
      COOKIE_DOMAIN: "${COOKIE_DOMAIN:-}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  ui-local-dev:
    hostname: "ui"
    <<: [*common, *logs]
    build:
      context: .
      dockerfile: dockerfiles/ui-dev.dockerfile
    command: "npm run dev"
    environment:
      <<: [*api_common_env, *hosts]
      PHAIDRA_DEFAULT_THEME: "${PHAIDRA_DEFAULT_THEME:-light}"
      PHAIDRA_DARK_PRIMARY_COLOR: "${PHAIDRA_DARK_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      LEGACY_OPEN_REDIRECT: "${LEGACY_OPEN_REDIRECT:-false}"
      IR_BASE_URL: "${IR_BASE_URL:-}"
      COOKIE_DOMAIN: "${COOKIE_DOMAIN:-}"
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]
    develop:
      watch:
        - action: sync
          path: ./src/phaidra-ui
          target: /usr/local/phaidra/phaidra-ui
          ignore:
            - node_modules/
        - action: sync
          path: ./src/phaidra-vue-components
          target: /usr/local/phaidra/phaidra-vue-components
          ignore:
            - node_modules/
        - action: rebuild
          path: ./src/phaidra-ui/package.json

  ui-s3-dev:
    hostname: "ui"
    <<: [*common, *logs]
    build:
      context: .
      dockerfile: dockerfiles/ui.dockerfile
    command: ["pm2-runtime", "start", "ecosystem.config.js"]
    environment:
      <<: [*api_common_env, *hosts]
      PHAIDRA_DEFAULT_THEME: "${PHAIDRA_DEFAULT_THEME:-light}"
      PHAIDRA_DARK_PRIMARY_COLOR: "${PHAIDRA_DARK_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_PRIMARY_COLOR: "${PHAIDRA_PRIMARY_COLOR:-#da3000}"
      PHAIDRA_DEFAULT_LANGUAGE: "${PHAIDRA_DEFAULT_LANGUAGE:-eng}"
      LEGACY_OPEN_REDIRECT: "${LEGACY_OPEN_REDIRECT:-false}"
      IR_BASE_URL: "${IR_BASE_URL:-}"
      COOKIE_DOMAIN: "${COOKIE_DOMAIN:-}"
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############### api ###############
  api-s3:
    hostname: "api"
    depends_on: [mariadb-phaidra, mongodb-phaidra, fedora-s3]
    image: phaidraorg/api-dist:065dd877
    <<: [*common, *logs]
    volumes:
      - s3-cache:/s3-cache
    environment:
      <<: [*api_common_env, *hosts, *s3]
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_ROOT_PATH: "s3-cache/derivates-images"
      SHIB_MAIL: "${SHIB_MAIL:-mail}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  api:
    hostname: "api"
    depends_on: [mariadb-phaidra, mongodb-phaidra, fedora]
    image: phaidraorg/api-dist:065dd877
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-images:/mnt/derivates-images:ro
      - derivates-3d:/mnt/derivates-3d:ro
      - derivates-expanded:/mnt/derivates-expanded:ro
    environment:
      <<: [*api_common_env, *hosts]
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_ROOT_PATH: "/mnt/derivates-images"
      SHIB_MAIL: "${SHIB_MAIL:-}"
    profiles: ["demo-local", "ssl-local", "shib-local"]

  api-local-dev:
    hostname: "api"
    image: phaidraorg/api-base:latest
    pull_policy: always
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - ./src/phaidra-api:/usr/local/phaidra/phaidra-api:ro
      - derivates-3d:/mnt/derivates-3d:ro
      - derivates-images:/mnt/derivates-images:ro
      - derivates-expanded:/mnt/derivates-expanded:ro
    environment:
      <<: [*api_common_env, *hosts]
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_ROOT_PATH: "/mnt/derivates-images"
      SHIB_MAIL: "${SHIB_MAIL:-}"
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  api-s3-dev:
    hostname: "api"
    image: phaidraorg/api-base:latest
    pull_policy: always
    <<: [*common, *logs]
    volumes:
      - s3-cache:/s3-cache
      - ./src/phaidra-api:/usr/local/phaidra/phaidra-api:ro
      - ./container_init/api/api-entrypoint.bash:/mnt/api-entrypoint.bash:ro
    environment:
      <<: [*api_common_env, *hosts, *s3]
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_ROOT_PATH: "s3-cache/derivates-images"
      SHIB_MAIL: "${SHIB_MAIL:-mail}"
    entrypoint: [ "bash", "/mnt/api-entrypoint.bash" ]
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############### libvips agent ###############
  agent-libvips:
    hostname: "agent-libvips"
    depends_on: [mongodb-phaidra, api]
    <<: [*common, *logs]
    image: phaidraorg/agent-libvips-dist:7d59b33b
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-images:/mnt/derivates-images
    environment:
      <<: [*api_common_env, *hosts]
      DERIVATES_IMAGES_PATH: "${DERIVATES_IMAGES_PATH:-/mnt/derivates-images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
    profiles: ["demo-local", "ssl-local", "shib-local"]
    
  agent-libvips-s3:
    hostname: "agent-libvips"
    depends_on: [mongodb-phaidra, api-s3, fedora-s3]
    <<: [*common, *logs]
    image: phaidraorg/agent-libvips-dist:7d59b33b
    environment:
      <<: [*api_common_env, *hosts, *s3]
      DERIVATES_IMAGES_PATH: "${DERIVATES_IMAGES_PATH:-/derivates-images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  agent-libvips-local-dev:
    hostname: "agent-libvips"
    image: phaidraorg/agent-libvips-base:7d59b33b
    pull_policy: always
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-images:/mnt/derivates-images
      - ./src/agents/libvips:/opt/agent-libvips:ro
    environment:
      <<: [*api_common_env, *hosts]
      DERIVATES_IMAGES_PATH: "${DERIVATES_IMAGES_PATH:-/mnt/derivates-images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  agent-libvips-s3-dev:
    hostname: "agent-libvips"
    depends_on: [mongodb-phaidra-dev, api-s3-dev, fedora-s3-dev]
    <<: [*common, *logs]
    image: phaidraorg/agent-libvips-base:7d59b33b
    pull_policy: always
    volumes:
      - ./src/agents/libvips:/opt/agent-libvips:ro
    environment:
      <<: [*api_common_env, *hosts, *s3]
      DERIVATES_IMAGES_PATH: "${DERIVATES_IMAGES_PATH:-/derivates-images}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_PORT: "${FEDORA_PORT:-8080}"
      FEDORA_PROTOCOL: "${FEDORA_PROTOCOL:-http}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############### opencast agent ###############
  agent-opencast:
    hostname: "agent-opencast"
    image: phaidraorg/agent-opencast-dist:7d59b33b
    <<: [*common, *logs]
    volumes:
      - agent-opencast-work:/opt/agent-opencast
      - agent-opencast-mongosh:/root/.mongodb
      - fedora:/mnt/fedora:ro
    depends_on: [mongodb-phaidra]
    environment:
      <<: [*api_common_env, *hosts]
      OC_EVENTS_URL: "${OC_EVENTS_URL:-}"
      OC_INGEST_URL: "${OC_INGEST_URL:-}"
      OC_USER: "${OC_USER:-}"
      OC_PASS: "${OC_PASS:-}"
      OC_WORKFLOW: "${OC_WORKFLOW:-}"
      M_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      M_PASS: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      M_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
    profiles: ["external-opencast"]

  agent-opencast-dev:
    hostname: "opencast"
    image: phaidraorg/opencast-base:7d59b33b
    pull_policy: always
    <<: [*common, *logs]
    volumes:
      - ./src/agents/opencast:/mnt/agent-opencast:ro
      - agent-opencast-work:/opt/agent-opencast
      - agent-opencast-mongosh:/root/.mongodb
      - fedora:/mnt/fedora:ro
    depends_on: [mongodb-phaidra-dev]
    environment:
      <<: [*api_common_env, *hosts]
      OC_EVENTS_URL: "${OC_EVENTS_URL:-}"
      OC_INGEST_URL: "${OC_INGEST_URL:-}"
      OC_USER: "${OC_USER:-}"
      OC_PASS: "${OC_PASS:-}"
      OC_WORKFLOW: "${OC_WORKFLOW:-}"
      M_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      M_PASS: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      M_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
    profiles: ["external-opencast-dev"]

  ############### obj2gltf agent ###############
  agent-obj2gltf:
    hostname: "agent-obj2gltf"
    image: phaidraorg/agent-obj2gltf:5614b72b
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-3d:/mnt/derivates-3d
    environment:
      <<: [*api_common_env, *hosts]
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGO_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
      CONVERTED_3D_PATH: "/mnt/derivates-3d"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
    depends_on:
      mongodb-phaidra:
        condition: "service_started"
        required: false
      mongodb-phaidra-dev:
        condition: "service_started"
        required: false
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]
  
  ############### unzip agent ###############
  agent-unzip:
    hostname: "agent-unzip"
    image: phaidraorg/agent-unzip:408f2ba8
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-expanded:/mnt/derivates-expanded
    environment:
      <<: [*api_common_env, *hosts]
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGO_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
      EXPANDED_PATH: "/mnt/derivates-expanded"
      FEDORA_DATA_PATH: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGE_CONVERSION_INTERVAL: "${IMAGE_CONVERSION_INTERVAL:-5}"
    depends_on:
      mongodb-phaidra:
        condition: "service_started"
        required: false
      mongodb-phaidra-dev:
        condition: "service_started"
        required: false
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### tika agent ###############
  agent-tika:
    hostname: "agent-tika"
    image: phaidraorg/agent-tika:408f2ba8
    <<: [*common, *logs]
    volumes:
      - fedora:/mnt/fedora:ro
      - derivates-extracts:/mnt/tika
    environment:
      <<: [*api_common_env, *hosts]
      MONGO_AGENT_DB: "${MONGO_AGENT_DB:-paf_mongodb}"
      SOLR_URL: "${SOLR_URL:-http://solr:8983/solr}"
      SOLR_COLLECTION: "${SOLR_COLLECTION:-phaidra}"
      SOLR_TEXT_FIELD: "${SOLR_TEXT_FIELD:-extracted_text}"
    depends_on:
      mongodb-phaidra:
        condition: "service_started"
        required: false
      mongodb-phaidra-dev:
        condition: "service_started"
        required: false
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### hdl agent ###############
  agent-hdl:
    hostname: "agent-hdl"
    image: phaidraorg/agent-hdl:408f2ba8
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      HANDLE_PREFIX: "${HANDLE_PREFIX:-}"
      HANDLE_ADMIN_PRIVKEY: "${HANDLE_ADMIN_PRIVKEY:-}"
    depends_on:
      mongodb-phaidra:
        condition: "service_started"
        required: false
      mongodb-phaidra-dev:
        condition: "service_started"
        required: false
    profiles:
      - handle

  ############### phaidra sql db ###############
  mariadb-phaidra:
    hostname: "mariadb-phaidra"
    image: phaidraorg/mariadb-phaidra-dist:62e27136
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MARIADB_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${PHAIDRADB:-phaidradb}"
      MARIADB_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mariadb-phaidra:/var/lib/mysql
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  mariadb-phaidra-dev:
    hostname: "mariadb-phaidra"
    image: mariadb:11.3.2-jammy
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MARIADB_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${PHAIDRADB:-phaidradb}"
      MARIADB_USER: "${MARIADB_PHAIDRA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - ./container_init/mariadb/phaidradb:/docker-entrypoint-initdb.d:ro
      - mariadb-phaidra:/var/lib/mysql
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### fedora sql db ###############
  mariadb-fedora:
    hostname: "mariadb-fedora"
    image: phaidraorg/mariadb-fedora-dist:789617f5
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MARIADB_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${FEDORADB:-fedoradb}"
      MARIADB_USER: "${MARIADB_FEDORA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      MARIADB_AUTO_UPGRADE: "1"
    volumes:
      - mariadb-fedora:/var/lib/mysql
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  mariadb-fedora-dev:
    hostname: "mariadb-fedora"
    image: mariadb:10.11
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MARIADB_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_DATABASE: "${FEDORADB:-fedoradb}"
      MARIADB_USER: "${MARIADB_FEDORA_USER:-phaidra}"
      MARIADB_PASSWORD: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      MARIADB_AUTO_UPGRADE: "1"
    volumes:
      - ./container_init/mariadb/fedoradb/fedoradb_grafana.sql:/docker-entrypoint-initdb.d/fedoradb_grafana.sql:ro
      - mariadb-fedora:/var/lib/mysql
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### phaidra document db ###############
  mongodb-phaidra:
    hostname: "mongodb-phaidra"
    image: phaidraorg/mongodb-dist:7cd9d090
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mongodb-phaidra:/data/db
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  mongodb-phaidra-dev:
    hostname: "mongodb-phaidra"
    image: mongo:5
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
    volumes:
      - mongodb-phaidra:/data/db
      - ./container_init/mongodb/init_oai_sets.json:/mnt/init_oai_sets.json:ro
      - ./container_init/mongodb/mongodb-after-entry.sh:/docker-entrypoint-initdb.d/mongodb-after-entry.sh:ro
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### dbgate ###############
  dbgate:
    hostname: "dbgate"
    image: dbgate/dbgate:6.8.2
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CONNECTIONS: con1,con2,con3
      LABEL_con1: MariaDB-Phaidra
      SERVER_con1: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra}"
      USER_con1: "${MARIADB_PHAIDRA_USER:-phaidra}"
      PASSWORD_con1: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      PORT_con1: 3306
      ENGINE_con1: mariadb@dbgate-plugin-mysql
      LABEL_con2: MariaDB-Fedora
      SERVER_con2: "${MARIADB_FEDORA_HOST:-mariadb-fedora}"
      USER_con2: "${MARIADB_FEDORA_USER:-phaidra}"
      PASSWORD_con2: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      PORT_con2: 3306
      ENGINE_con2: mariadb@dbgate-plugin-mysql
      LABEL_con3: MongoDB-Phaidra
      URL_con3: "mongodb://${MONGODB_PHAIDRA_USER:-phaidra}:${MONGODB_PHAIDRA_PASSWORD:-phaidra}@${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}:27017"
      ENGINE_con3: mongo@dbgate-plugin-mongo
      WEB_ROOT: /dbgate
      LOGINS: phaidra
      LOGIN_PASSWORD_phaidra: "${DBGATE_PASS:-phaidra}"
    volumes:
      - dbgate:/root/.dbgate
    depends_on: [mariadb-phaidra, mariadb-fedora, mongodb-phaidra]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  dbgate-dev:
    hostname: "dbgate"
    image: dbgate/dbgate:6.8.2
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CONNECTIONS: con1,con2,con3
      LABEL_con1: MariaDB-Phaidra
      SERVER_con1: "${MARIADB_PHAIDRA_HOST:-mariadb-phaidra-dev}"
      USER_con1: "${MARIADB_PHAIDRA_USER:-phaidra}"
      PASSWORD_con1: "${MARIADB_PHAIDRA_PASSWORD:-phaidra}"
      PORT_con1: 3306
      ENGINE_con1: mariadb@dbgate-plugin-mysql
      LABEL_con2: MariaDB-Fedora
      SERVER_con2: "${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}"
      USER_con2: "${MARIADB_FEDORA_USER:-phaidra}"
      PASSWORD_con2: "${MARIADB_FEDORA_PASSWORD:-phaidra}"
      PORT_con2: 3306
      ENGINE_con2: mariadb@dbgate-plugin-mysql
      LABEL_con3: MongoDB-Phaidra
      URL_con3: "mongodb://${MONGODB_PHAIDRA_USER:-phaidra}:${MONGODB_PHAIDRA_PASSWORD:-phaidra}@${MONGODB_PHAIDRA_HOST:-mongodb-phaidra-dev}:27017"
      ENGINE_con3: mongo@dbgate-plugin-mongo
      WEB_ROOT: /dbgate
      LOGINS: phaidra
      LOGIN_PASSWORD_phaidra: "${DBGATE_PASS:-phaidra}"
    volumes:
      - dbgate:/root/.dbgate
    depends_on: [mariadb-phaidra-dev, mariadb-fedora-dev, mongodb-phaidra-dev]
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]


  ############### cronjobs service ###############
  chronos:
    hostname: "chronos"
    image: phaidraorg/chronos-dist:5ed15fa2
    <<: [*common, *logs]
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - derivates-images:/mnt/derivates-images
    environment:
      <<: [*api_common_env, *hosts]
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      OUTSIDE_HTTP_SCHEME: "${OUTSIDE_HTTP_SCHEME:-http}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_ROOT_PATH: "/mnt/derivates-images"
    depends_on: [mariadb-fedora, mariadb-phaidra, mongodb-phaidra, fedora]
    profiles: ["demo-local", "ssl-local", "shib-local"]

  chronos-s3:
    hostname: "chronos"
    image: phaidraorg/chronos-dist:5ed15fa2
    <<: [*common, *logs]
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - derivates-images:/mnt/derivates-images
    environment:
      <<: [*api_common_env, *hosts]
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_ROOT_PATH: "s3-cache/derivates-images"
    depends_on: [mariadb-fedora, mariadb-phaidra, mongodb-phaidra, fedora-s3]
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  chronos-dev:
    hostname: "chronos"
    image: phaidraorg/chronos-base:latest
    <<: [*common, *logs]
    pull_policy: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - derivates-images:/mnt/derivates-images
      - ./container_init/chronos:/mnt/chronos:ro
    environment:
      <<: [*api_common_env, *hosts]
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-/mnt/fedora/data/ocfl-root}"
      IMAGESERVER_ROOT_PATH: "/mnt/derivates-images"
    depends_on: [mariadb-fedora-dev, mariadb-phaidra-dev, mongodb-phaidra-dev, fedora-local-dev]
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  chronos-s3-dev:
    hostname: "chronos"
    image: phaidraorg/chronos-base:latest
    <<: [*common, *logs]
    pull_policy: always
    volumes:
      - chronos-database-dumps:/mnt/database-dumps
      - chronos-sitemaps:/mnt/sitemaps
      - chronos-oai-logs:/mnt/oai-logs
      - derivates-images:/mnt/derivates-images
      - ./container_init/chronos:/mnt/chronos:ro
    environment:
      <<: [*api_common_env, *hosts]
      FEDORADB: "${FEDORADB:-fedoradb}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      MARIADB_FEDORA_ROOT_PASSWORD: "${MARIADB_FEDORA_ROOT_PASSWORD:-example}"
      MARIADB_PHAIDRA_ROOT_PASSWORD: "${MARIADB_PHAIDRA_ROOT_PASSWORD:-example}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      PHAIDRADB: "${PHAIDRADB:-phaidradb}"
      FEDORA_OCFL_ROOT: "${FEDORA_OCFL_ROOT:-}"
      IMAGESERVER_ROOT_PATH: "s3-cache/derivates-images"
    depends_on: [mariadb-fedora-dev, mariadb-phaidra-dev, mongodb-phaidra-dev, fedora-s3-dev]
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]
  
  ############### promtail ###############
  promtail:
    hostname: "promtail"
    image: phaidraorg/promtail-dist:4757f6c2
    volumes:
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yaml -config.expand-env=true
    <<: *common
    environment:
      <<: [*api_common_env, *hosts]
      LOKI_HOST: "loki"
    depends_on: [grafana, loki]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  promtail-dev:
    hostname: "promtail"
    image: grafana/promtail:3.6.7
    volumes:
      - ./container_init/promtail/promtail-local-config.yaml:/etc/promtail/config.yaml:ro
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    environment:
      <<: [*api_common_env, *hosts]
      LOKI_HOST: "loki-dev"
    command: -config.file=/etc/promtail/config.yaml -config.expand-env=true
    <<: *common
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### grafana loki ###############
  loki:
    hostname: "loki"
    image: phaidraorg/loki-dist:18ba0328
    volumes:
      - loki:/loki
    command: -config.file=/etc/loki/local-config.yaml
    <<: *common
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  loki-dev:
    hostname: "loki"
    image: grafana/loki:3.6.7
    volumes:
      - ./container_init/loki/loki-docker-config.yaml:/etc/loki/local-config.yaml:ro
      - loki:/loki
    command: -config.file=/etc/loki/local-config.yaml
    <<: *common
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### grafana ###############
  grafana:
    hostname: "grafana"
    image: phaidraorg/grafana-dist:6e2c4690
    volumes:
      - grafana:/var/lib/grafana
    environment:
      <<: [*api_common_env, *hosts]
      GF_SECURITY_ADMIN_USER: "${GF_SECURITY_ADMIN_USER:-phaidra}"
      GF_SECURITY_ADMIN_PASSWORD: "${GF_SECURITY_ADMIN_PASSWORD:-phaidra}"
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/mnt/grafana/dashboards/phaidra_default.json"
      LOKI_HOST: "loki"
      PROMETHEUS_HOST: "prometheus"
    depends_on: [loki]
    <<: *common
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  grafana-dev:
    hostname: "grafana"
    image: grafana/grafana:12.3.3
    volumes:
      - ./container_init/grafana/ds.yaml:/etc/grafana/provisioning/datasources/ds.yaml:ro
      - ./container_init/grafana/dd.yaml:/etc/grafana/provisioning/dashboards/dd.yaml:ro
      - ./container_init/grafana/dashboards:/mnt/grafana/dashboards:ro
      - grafana:/var/lib/grafana
    environment:
      <<: [*api_common_env, *hosts]
      GF_SECURITY_ADMIN_USER: "${GF_SECURITY_ADMIN_USER:-phaidra}"
      GF_SECURITY_ADMIN_PASSWORD: "${GF_SECURITY_ADMIN_PASSWORD:-phaidra}"
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/mnt/grafana/dashboards/phaidra_default.json"
      LOKI_HOST: "loki-dev"
      PROMETHEUS_HOST: "prometheus-dev"
    depends_on: [loki-dev]
    <<: *common
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### prometheus ###############
  prometheus:
    hostname: "prometheus"
    image: phaidraorg/prometheus-dist:4f0a3c9d
    volumes:
      - ./container_init/prometheus:/mnt/startup:ro
      - prometheus:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    <<: *common
    environment:
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
    entrypoint: [ "/mnt/startup/prometheus-entrypoint.sh" ]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  prometheus-dev:
    hostname: "prometheus"
    image: prom/prometheus:v2.55.1
    volumes:
      - ./container_init/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - ./container_init/prometheus:/mnt/startup:ro
      - prometheus:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    <<: *common
    environment:
      FEDORA_ADMIN_USER: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASS: "${FEDORA_ADMIN_PASS:-1234}"
      PHAIDRA_ADMIN_USER: "${PHAIDRA_ADMIN_USER:-phaidraAdmin}"
      PHAIDRA_ADMIN_PASSWORD: "${PHAIDRA_ADMIN_PASSWORD:-12345}"
    entrypoint: [ "/mnt/startup/prometheus-entrypoint.sh" ]
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### iipsrv imageserver ##############
  imageserver:
    hostname: "imageserver"
    image: phaidraorg/imageserver:50dbad75
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env]
      MAX_IMAGE_CACHE_SIZE: 7000
    volumes:
      - ./container_init/imageserver:/mnt/startup:ro
      - derivates-images:/mnt/derivates-images:ro
    entrypoint: [ "bash", "/mnt/startup/imageserver-entrypoint.bash" ]
    profiles: ["demo-local", "ssl-local", "shib-local"]

  imageserver-local-dev:
    hostname: "imageserver"
    build:
      context: .
      dockerfile: dockerfiles/imageserver.dockerfile
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *imageserver_env]
    volumes:
      - derivates-images:/mnt/derivates-images:ro
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  imageserver-s3:
    hostname: "imageserver"
    image: phaidraorg/imageserver:50dbad75
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env]
    volumes:
      - ./container_init/imageserver:/mnt/startup:ro
      - s3-cache:/s3-cache:ro
    entrypoint: [ "bash", "/mnt/startup/imageserver-entrypoint.bash" ]
    profiles: ["demo-s3", "ssl-s3", "shib-s3", "demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############## fedora ###############
  fedora:
    hostname: "fedora"
    image: fcrepo/fcrepo:6.5.1-whikloj-simple-search-queries
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CATALINA_OPTS: >-
        -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}
        -Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora}:3306/${FEDORADB:-fedoradb}
        -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra}
        -Dfcrepo.metrics.enable=true
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora]
    volumes:
      - fedora:/usr/local/tomcat/fcrepo-home
    profiles: ["demo-local", "ssl-local", "shib-local"]

  fedora-s3:
    hostname: "fedora"
    image: fcrepo/fcrepo:6.5.1-whikloj-simple-search-queries
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CATALINA_OPTS: >-
        -Dfcrepo.aws.access-key=${S3_ACCESS_KEY:-phaidra}
        -Dfcrepo.aws.region=${S3_REGION:-eu-central-1}
        -Dfcrepo.aws.secret-key=${S3_SECRET_KEY:-phaidraphaidra}
        -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}
        -Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora}:3306/${FEDORADB:-fedoradb}
        -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra}
        -Dfcrepo.ocfl.s3.bucket=${S3_BUCKETNAME:-phaidra-bucket}
        -Dfcrepo.ocfl.s3.prefix=fedora
        -Dfcrepo.s3.endpoint=${S3_ENDPOINT:-http://minio:9000}
        -Dfcrepo.s3.path.style.access=true
        -Dfcrepo.storage=ocfl-s3
        -Dfcrepo.metrics.enable=true
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora]
    profiles: ["demo-s3", "ssl-s3", "shib-s3"]

  fedora-local-dev:
    hostname: "fedora"
    image: fcrepo/fcrepo:6.5.1-whikloj-simple-search-queries
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CATALINA_OPTS: >-
        -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}
        -Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora-Dev}:3306/${FEDORADB:-fedoradb}
        -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra}
        -Dfcrepo.metrics.enable=true
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora-dev]
    volumes:
      - fedora:/usr/local/tomcat/fcrepo-home
    profiles: ["demo-local-dev", "ssl-local-dev", "shib-local-dev"]

  fedora-s3-dev:
    hostname: "fedora"
    image: fcrepo/fcrepo:6.5.1-whikloj-simple-search-queries
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      CATALINA_OPTS: >-
        -Dfcrepo.aws.access-key=${S3_ACCESS_KEY:-phaidra}
        -Dfcrepo.aws.region=${S3_REGION:-eu-central-1}
        -Dfcrepo.aws.secret-key=${S3_SECRET_KEY:-phaidraphaidra}
        -Dfcrepo.db.password=${MARIADB_FEDORA_PASSWORD:-phaidra}
        -Dfcrepo.db.url=jdbc:mariadb://${MARIADB_FEDORA_HOST:-mariadb-fedora-dev}:3306/${FEDORADB:-fedoradb}
        -Dfcrepo.db.user=${MARIADB_FEDORA_USER:-phaidra}
        -Dfcrepo.ocfl.s3.bucket=${S3_BUCKETNAME:-phaidra-bucket}
        -Dfcrepo.ocfl.s3.db.enabled=false
        -Dfcrepo.ocfl.s3.prefix=fedora
        -Dfcrepo.s3.endpoint=${S3_ENDPOINT:-http://minio:9000}
        -Dfcrepo.s3.path.style.access=true
        -Dfcrepo.storage=ocfl-s3
        -Dfcrepo.metrics.enable=true
      FEDORA_ADMIN_USERNAME: "${FEDORA_ADMIN_USER:-fedoraAdmin}"
      FEDORA_ADMIN_PASSWORD: "${FEDORA_ADMIN_PASS:-1234}"
    depends_on: [mariadb-fedora-dev]
    profiles: ["demo-s3-dev", "ssl-s3-dev", "shib-s3-dev"]

  ############## camel-toolbox service ###############
  camel-toolbox:
    image: phaidraorg/fcrepo-camel-toolbox:39bf4894
    <<: [*common, *logs]
    volumes:
      - "./camel-toolbox-config:/config"
      - "./scripts/fixity_handler.sh:/usr/local/bin/fixity_handler.sh"
    command:
      - -c
      - "/config/configuration.properties"
    environment:
      <<: [*api_common_env, *hosts]
      MONGODB_PHAIDRA_USER: "${MONGODB_PHAIDRA_USER:-phaidra}"
      MONGODB_PHAIDRA_PASSWORD: "${MONGODB_PHAIDRA_PASSWORD:-phaidra}"
      MONGODB_PHAIDRA_HOST: "${MONGODB_PHAIDRA_HOST:-mongodb-phaidra}"
      MONGODB_DATABASE: "fixity"
      MONGODB_PORT: "27017"
      MONGODB_COLLECTION: "fixity_failures"
      SMTP_HOST: "${SMTP_HOST:-}"
      SMTP_PORT: "${SMTP_PORT:-}"
      SMTP_USERNAME: "${SMTP_USERNAME:-}"
      SMTP_PASSWORD: "${SMTP_PASSWORD:-}"
      SMTP_FROM: "${SMTP_FROM:-}"
      SMTP_TO: "${SMTP_TO:-}"
    depends_on:
      mongodb-phaidra:
        condition: "service_started"
        required: false
      mongodb-phaidra-dev:
        condition: "service_started"
        required: false
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### ldap manager ###############
  lam:
    hostname: "lam"
    image: ghcr.io/ldapaccountmanager/lam:9.3
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      LDAP_DOMAIN: "${LDAP_SLD:-example}.${LDAP_TLD:-org}"
      LDAP_SERVER: "${LDAP_PROTOCOL:-ldap}://${LDAP_HOSTNAME:-openldap}:${LDAP_PORT_NUMBER:-1389}"
      LDAP_USER: "cn=${LDAP_ADMIN_USERNAME:-admin},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_USERS_DN: "ou=${LDAP_USERS_OU:-people},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_GROUPS_DN: "ou=${LDAP_GROUPS_OU:-groups},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
    depends_on: [openldap]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  lam-dev:
    hostname: "lam"
    image: ghcr.io/ldapaccountmanager/lam:9.3
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      LDAP_DOMAIN: "${LDAP_SLD:-example}.${LDAP_TLD:-org}"
      LDAP_SERVER: "${LDAP_PROTOCOL:-ldap}://${LDAP_HOSTNAME:-openldap-dev}:${LDAP_PORT_NUMBER:-1389}"
      LDAP_USER: "cn=${LDAP_ADMIN_USERNAME:-admin},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_USERS_DN: "ou=${LDAP_USERS_OU:-people},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_GROUPS_DN: "ou=${LDAP_GROUPS_OU:-groups},dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
    depends_on: [openldap-dev]
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]
    
  ############### openldap ###############
  openldap:
    hostname: "openldap"
    image: phaidraorg/openldap-dist:10a6b315
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_PORT_NUMBER: "${LDAP_PORT_NUMBER:-1389}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_CUSTOM_LDIF_DIR: "/ldifs"
    volumes:
      - openldap:/bitnami/openldap
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3"]

  openldap-dev:
    hostname: "openldap"
    image: phaidraorg/openldap-dist:10a6b315
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      LDAP_ADMIN_USERNAME: "${LDAP_ADMIN_USERNAME:-admin}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD:-adminpassword}"
      LDAP_PORT_NUMBER: "${LDAP_PORT_NUMBER:-1389}"
      LDAP_ROOT: "dc=${LDAP_SLD:-example},dc=${LDAP_TLD:-org}"
      LDAP_CUSTOM_LDIF_DIR: "/ldifs"
    volumes:
      - openldap:/bitnami/openldap
      - ./container_init/openldap/init.ldif:/ldifs/init.ldif:ro
    profiles: ["demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### node-exporter: retrieves host memory usage (scraped by prometheus) ###############
  node-exporter:
    image: prom/node-exporter:v1.10.2
    <<: *common
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### cadvisor: retrieves container metrics (scraped by prometheus) ###############
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.52.1
    <<: *common
    volumes:
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /etc/machine-id:/etc/machine-id:ro
      - ${HOST_DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### apache-exporter ###############
  apache-exporter:
    hostname: "apache-exporter"
    image: lusotycoon/apache-exporter:v1.0.12
    command: --scrape_uri="http://httpd:8081/?auto"
    <<: [*common, *logs]
    profiles: ["demo-local", "demo-s3", "ssl-local", "ssl-s3", "shib-local", "shib-s3", "demo-local-dev", "demo-s3-dev", "ssl-local-dev", "ssl-s3-dev", "shib-local-dev", "shib-s3-dev"]

  ############### mkdocs for website generation ###############
  mkdocs:
    image: squidfunk/mkdocs-material:latest
    hostname: mkdocs
    pull_policy: always
    # use build to build static files locally (within /site dir) which then can be pushed to server
    # command: "build"
    command: "serve --dev-addr=0.0.0.0:8000"
    volumes:
      - ./:/docs
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    profiles: ["website"]

  #################### minio ####################
  minio-s3-dev:
    hostname: "minio"
    image: minio/minio:latest
    <<: [*common, *logs]
    environment:
      MINIO_ROOT_USER: "${S3_ACCESS_KEY:-phaidra}"
      MINIO_ROOT_PASSWORD: "${S3_SECRET_KEY:-phaidraphaidra}"
    ports:
      - 9001:9001
    volumes:
      - minio:/data
    entrypoint: bash
    command: ["-c", 'mkdir /data/${S3_BUCKETNAME:-phaidra-bucket}; /usr/bin/minio server /data --console-address :9001']
    profiles: ["minio-s3-dev"]

  #################### handle server ####################
  handle:
    hostname: "handle"
    <<: [*common, *logs]
    environment:
      <<: [*api_common_env, *hosts]
      HANDLE_PUBLIC_IP: "${HANDLE_PUBLIC_IP:-}"
    build:
      context: .
      dockerfile: dockerfiles/handle.dockerfile
    image: phaidraorg/handle:8cc00b0c
    pull_policy: missing
    read_only: true
    ports:
      - 2641:2641/tcp
      - 2641:2641/udp
    volumes:
      - handle:/opt/handle-data
      - ./certs/handle/privkey.bin:/opt/handle-data/privkey.bin:ro
      - ./certs/handle/pubkey.bin:/opt/handle-data/pubkey.bin:ro
    profiles:
      - handle
    
volumes:
  chronos-database-dumps:
  chronos-oai-logs:
  chronos-sitemaps:
  dbgate:
  fedora:
  grafana:
  loki:
  mariadb-fedora:
  mariadb-phaidra:
  mdcerts:
  minio:
  mongodb-phaidra:
  openldap:
  derivates-images:
  derivates-3d:
  derivates-extracts:
  derivates-expanded:
  prometheus:
  s3-cache:
  solr:
  agent-opencast-mongosh:
  agent-opencast-work:
  handle:

configs:
  httpd_custom_config:
    file: ./configs/httpd_custom.conf
  varnish_config:
    file: ./configs/varnish.vcl
  shibboleth_attribute_map:
    file: ./configs/shib/attribute-map.xml
  shibboleth_attribute_policy:
    file: ./configs/shib/attribute-policy.xml
